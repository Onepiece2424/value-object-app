<div class="item-main-form">
  <%= form_with(model: @item, local: true) do |form| %>

    <% if @item.errors.any? %>
      <div id="error_explanation">
        <h2><%= pluralize(@item.errors.count, "error") %> prevented this item from being saved:</h2>
        <ul>
          <% @item.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <table class="item-form-table">
      <tr>
        <td><%= form.label :name, "Item Name" %></td>
        <td><%= form.text_field :name %></td>
      </tr>

      <tr>
        <td><%= form.label :description, "Description" %></td>
        <td class="item-form-description"><%= form.text_area :description %></td>
      </tr>

      <tr>
        <td><%= form.label :price, "Price" %></td>
        <td><%= form.number_field :price, min: 1 %></td>
      </tr>

      <tr>
        <td><%= form.label :stock, "Stock Quantity" %></td>
        <td><%= form.number_field :stock, min: 1 %></td>
      </tr>

      <tr>
        <td>
          <div class="label-area">
            <label for="manufacture_date">Manufacture Date</label>
            <button type="button" id="add-production-date-btn">生産日を追加する</button>
          </div>
        </td>
        <td>
          <div class="production-date-area">
            <%= form.fields_for :production_dates do |pd_form| %>
              <div class="production-date-group" data-index="<%= pd_form.index %>">
                <%= pd_form.date_field :manufacture_date %>
                <%= pd_form.hidden_field :_destroy %>
                <span class="delete-form-btn">削除する</span>
              </div>
            <% end %>
          </div>
        </td>
      </tr>

      <tr>
        <td colspan="2"><%= form.submit "Create Item" %></td>
      </tr>
    </table>

  <% end %>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const productionDateArea = document.querySelector('.production-date-area');
    const addProductionDateBtn = document.getElementById('add-production-date-btn');

    addProductionDateBtn.addEventListener('click', () => {
      const newIndex = productionDateArea.children.length;
      const newGroup = document.createElement('div');
      newGroup.className = 'production-date-group';
      newGroup.dataset.index = newIndex;

      newGroup.innerHTML = `
        <input type="date" name="item[production_dates_attributes][${newIndex}][manufacture_date]" id="item_production_dates_attributes_${newIndex}_manufacture_date">
        <input type="hidden" name="item[production_dates_attributes][${newIndex}][_destroy]" id="item_production_dates_attributes_${newIndex}__destroy">
        <span class="delete-form-btn">削除する</span>
      `;

      productionDateArea.appendChild(newGroup);
    });

    productionDateArea.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-form-btn')) {
        const group = e.target.closest('.production-date-group');
        group.querySelector('input[type="hidden"]').value = '1';  // 削除フラグをセット
        group.style.display = 'none';  // 見た目上、削除
      }
    });
  });
</script>
</div>
